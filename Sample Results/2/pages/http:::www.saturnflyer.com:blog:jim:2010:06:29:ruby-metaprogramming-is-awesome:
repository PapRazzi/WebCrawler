<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta name="keywords" content="Jim Gay, Radiant CMS, Ruby on Rails, Rockport Publishers, LogoLounge, Logo Lounge, kryptosima, search engine optimization, logo, brand strategy, graphic design, web designer, site design, designer, website promotion, accessibility, usability, 508, WCAG, WAI, guidelines, development, marketing, webpage, branding, logos, graphics, print design, flash, shockwave, trademarks, CSS, HTML, XHTML, XML, Saturn Flyer, e-commerce solution, Ecommerce, affordable" />
<meta name="description" content="Saturn Flyer is a graphic design and software development studio that provides it clients with creative and functional solutions. Application development, logo design, interaction architecture, stationery, website design, brochures, interactive marketing and  brand strategy are just some of our offerings." />
<meta name="author" content="Jim Gay" />
<meta name="Copyright" content="Copyright (c) 1999 - 2013 Saturn Flyer" />
<meta name="ROBOTS" content="ALL" />
<meta http-equiv="Pragma" content="no-cache" />
<meta name="google-site-verification" content="IQhXF5pYUaEKMELzZAWkcJASAwN3fTeFRwf1SRCtB8I" /
<link rel="alternate" type="application/rss+xml" title="Blog feed" href="http://feeds2.feedburner.com/saturnflyer/blog" />
<link rel="alternate" type="application/rss+xml" title="Articles feed" href="http://feeds2.feedburner.com/saturnflyer/articles" />
<link rel="alternate" type="application/rss+xml" title="Articles and Blog feed" href="http://feeds2.feedburner.com/saturnflyer" />
	<link rel="stylesheet" href="/stylesheets/site.css" type="text/css" media="screen" />
	<title>Ruby Metaprogramming is Awesome - Saturn Flyer with Jim Gay </title>
</head>
<body>
<div id="galaxy">
	<div id="header">
		<h1><a href="http://www.saturnflyer.com/"><img src="/images/saturnflyer.gif" alt="Saturn Flyer" width="124" height="28" /></a></h1>
	</div>
<div id="content" class="spaced">





  

  <h1>Ruby Metaprogramming is Awesome</h1>
  <p class="info">by Jim Gay</p>
  <p>If you&rsquo;ve come to read about how wrong I am about metaprogramming, don&rsquo;t worry, I&rsquo;m sure I&rsquo;ll follow-up with a post about how bad it is to do metaprogramming and how it causes you real, physical pain.</p>

<p>If, however, you&rsquo;ve come to find out about how awesome metaprogramming is, then you can tell by the title of this article that you are in the right place! Now that&rsquo;s authoritative!</p>

<p>The best part about this article is that it is for <strong>you</strong>! That&rsquo;s right, newbie. <em>I&rsquo;m not going in-depth, I&rsquo;m merely going to discuss how a dash of metaprogramming solved an annoying problem.</em></p>

<p>I do a lot of work with <a href="http://radiantcms.org">Radiant</a>. And Radiant manages pages well, but there are <a href="http://ext.radiantcms.org/">plenty of extensions</a> that allow you to do other things. You can, for example, add the ability to <a href="http://ext.radiantcms.org/extensions/20-paperclipped">upload files and whatnot</a>. Or you can add the ability to edit <a href="http://ext.radiantcms.org/extensions/53-sns">stylesheets and javascripts</a>.</p>

<p>That&rsquo;s pretty cool. Radiant does a good job of managing pages in the <code>pages</code> table. But stylesheets and javascripts are not pages. Some of the samples that Radiant bundles have stylesheets as regular pages in the page tree and are tied to an almost blank layout that sets a particular content-type like <code>text/css</code>. Yuck. So Chris Parrish, the author of SNS, added <code>text_assets</code> to handle other types of content like stylesheets and javascripts.</p>

<p>One of his reasons for creating this extension is the weirdness of having a stylesheet in your page tree: &ldquo;No more confused users wonder what those fancy pages are.&rdquo; Saaaweet! Thanks, Chris.</p>

<p>All is well until you find out that the SNS extension doesn&rsquo;t let you use your typical Radius tags within javascripts or stylesheets like:</p>

<pre><code>#something { background: url('&lt; r:assets:url title="my_image" /&gt;'); }
</code></pre>

<p>Nooooooo! Why, God, why!?!</p>

<p>Well, with SNS, you&rsquo;re dealing with a <code>TextAsset</code> and not a <code>Page</code>. But if you&rsquo;re familiar with Radiant, you know that page tags aren&rsquo;t only used on pages, they&rsquo;re used on snippets and layouts too. So what&rsquo;s the deal with that?</p>

<p>All of the radius tags that you use in Radiant are evaluated in the context of a single page. Pages, snippets, and layouts are all used in reference to rendering a <code>Page</code>. But SNS renders a <code>TextAsset</code> and as a result, it doesn&rsquo;t have any of the fancy tags added. Afterall, it&rsquo;s <code>class TextAsset &lt; ActiveRecord::Base</code> and not <code>class TextAsset &lt; Page</code>.</p>

<p>You read that right: text assets are not pages. Bummer, dude.</p>

<p>Well, what if you could include the same modules as are included in the <code>Page</code> model? Then you could use those tags in your stylesheets.</p>

<p>Fire up your console because you&rsquo;re about to see how to do it. In a rails console (for a Radiant instance), try this:</p>

<pre><code>Page.included_modules
</code></pre>

<p>And you&rsquo;ll get back a bunch that don&rsquo;t matter for you. Let&rsquo;s simplify that:</p>

<pre><code>&gt;&gt; Page.included_modules.select{|m| m.to_s =~ /Tags$/}
=&gt; [TextileTags, SmartyPantsTags, MarkdownTags, StandardTags]
</code></pre>

<p>Awesome. All we need to do is include all of those modules into TextAsset and we&rsquo;re done! <em>Almost.</em></p>

<p>Since we&rsquo;re dealing with the SNS extension, you&rsquo;ll also see that it includes <code>Sns::PageTags</code> which adds tags to output stylesheets and javascripts. Those, we don&rsquo;t need. So we can filter them out and include them into TextAsset:</p>

<pre><code>TextAsset.class_eval {
  Page.included_modules.select{|m| m.to_s =~ /Tags$/}.reject{|m| m == Sns::PageTags }.each do |mod|
    include mod
  end
}
</code></pre>

<p>Bingo! Now we&rsquo;re in business. Except for the fact that it doesn&rsquo;t work.</p>

<p>So we need to update the context in which these tags are evaluated. Since they are all written expecting to be included in a Page model, the global variables for the tags need to have knowledge of a page.</p>

<pre><code>TextAssetContext.class_eval {
  def initialize(text_asset)
    super()
    globals.page = text_asset # This is the important line that adds the hook for all existing tags for pages.
    globals.text_asset = text_asset
    text_asset.tags.each do |name|
      define_tag(name) { |tag_binding| text_asset.render_tag(name, tag_binding) }
    end
  end
}
</code></pre>

<p>There you have it. All it took was some <code>class<em>eval</code> and some looping over <code>included</em>modules</code>.</p>

<p><img src="http://ext.radiantcms.org/system/screenshots/232/large/Radiant_CMS_-_.jpg" alt="page tags in stylesheets" /> And now you&rsquo;ll have happy users. Because even though Chris solved the problem of weird stylesheet pages in the page tree, the solution introduced a problem where editors of the site expect the radius tags to simply work everywhere. <a href="http://ext.radiantcms.org/extensions/232-sns-page-hook">Now they do</a>.</p>

<p>The above code assumes that the only valuable tags are those whose modules have &ldquo;Tags&rdquo; at the end of their names. That&rsquo;s a reasonable expectation, but we can go even further by inspecting the included modules of the included modules to see if <code>Radiant::Taggable</code> is there:</p>

<pre><code>TextAsset.class_eval {
  Page.included_modules.reject{|m| m == Sns::PageTags }.each do |mod|
    if mod.included_modules.any? {|inc| inc == Radiant::Taggable }
      include mod
    end
  end
}
</code></pre>

<p>So go ahead and install the page attachments, or paperclipped, or whatever extension with sns and just do <code>script/extension install sns<em>page</em>hook</code>, or better yet: <code>gem install radiant-sns<em>page</em>hook-extension</code>. Please <a href="http://github.com/saturnflyer/radiant-sns_page_hook-extension/issues">let me know</a> if you find any problems with it.</p>
  
  <div class="comments">
    <h2>Comments</h2>
    
      
  <div class="comment" id="comment-110">
    <p class="author">
      Wes Gamble<img src="http://www.gravatar.com/avatar/bb4bdf2b184027bc38d4fb529770cde5?s=40" class="gravatar" />
      said on Friday, July 02, 2010:
    </p>
    
    <div class="content_html"><p>Rails 2.3.8<br />
Radiant 0.9.1</p>
<p>When I install this gem and include it in my config file using:</p>
<p>config.gem &#8216;radiant-sns_page_hook-extension&#8217;, :lib =&gt; &#8216;sns_page_hook_extension&#8217;, :version =&gt; &#8216;&gt;= 1.0.0&#8217;</p>
<p>and restart my server, I get:</p>
<p>/Users/weyus/Documents/workspace/koached-content/vendor/radiant/lib/radiant/extension.rb:106:in `inherited&#8217;: undefined method `to_name&#8217; for <a href="String">SnsPageHookExtension</a> (NoMethodError)</p>
<p>Not sure what the problem is.</p></div>
    
    
  </div>


    
      
  <div class="comment" id="comment-111">
    <p class="author">
      <a href="http://www.saturnflyer.com">Jim Gay</a><img src="http://www.gravatar.com/avatar/09477c358c5897d44121a248326e16d7?s=40" class="gravatar" />
      said on Saturday, July 03, 2010:
    </p>
    
    <div class="content_html"><p>Wes,</p>

<p>Can you try this:</p>

<pre><code>config.gem ‘radiant-sns_page_hook-extension’, :lib =&amp;gt;false
</code></pre>
</div>
    
    
  </div>


    
      
  <div class="comment" id="comment-113">
    <p class="author">
      <a href="http://rushthinking.com">Amr</a><img src="http://www.gravatar.com/avatar/1be13b794a692d0b083fb52485eb22ea?s=40" class="gravatar" />
      said on Sunday, August 22, 2010:
    </p>
    
    <div class="content_html"><p>Is it possible to edit /css or /js slug path through Settings ext??<br />
Its really needed!</p></div>
    
    
  </div>


    
      
  <div class="comment" id="comment-114">
    <p class="author">
      <a href="http://www.saturnflyer.com">Jim Gay</a><img src="http://www.gravatar.com/avatar/09477c358c5897d44121a248326e16d7?s=40" class="gravatar" />
      said on Wednesday, August 25, 2010:
    </p>
    
    <div class="content_html"><p>Amr, <span class="caps">SNS</span> has details about how to edit those paths. http://github.com/radiant/radiant-sns-extension/blob/master/lib/tasks/sns_extension_tasks.rake#L81</p></div>
    
    
  </div>


    
      
  <div class="comment" id="comment-128">
    <p class="author">
      <a href="http://omeryavuz.gen.tr">omer</a><img src="http://www.gravatar.com/avatar/af4d55d4e752cb46e56f37aee8caba96?s=40" class="gravatar" />
      said on Thursday, October 28, 2010:
    </p>
    
    <div class="content_html"><p>Whenever I tried,</p>
<p>uninitialized constant SnsPageHookExtension::TextAsset</p>
<p>What is problem?</p></div>
    
    
  </div>


    
      
  <div class="comment" id="comment-129">
    <p class="author">
      <a href="http://omeryavuz.gen.tr">omer</a><img src="http://www.gravatar.com/avatar/af4d55d4e752cb46e56f37aee8caba96?s=40" class="gravatar" />
      said on Thursday, October 28, 2010:
    </p>
    
    <div class="content_html"><p>hello,<br />
I had problem about installation sns-extension<br />
I solved problem <br />
I installed sns before<br />
I am new on radiant, please update documentation for sns extension<br />
omer</p></div>
    
    
  </div>


    
      
  <div class="comment" id="comment-130">
    <p class="author">
      <a href="http://www.saturnflyer.com">Jim Gay</a><img src="http://www.gravatar.com/avatar/09477c358c5897d44121a248326e16d7?s=40" class="gravatar" />
      said on Thursday, October 28, 2010:
    </p>
    
    <div class="content_html"><p>Omer, <br />
This article assumes that you are using <span class="caps">SNS</span>. I&#39;m glad you got it working, but it&#39;s pretty clear about that.</p></div>
    
    
  </div>


    
  </div>


  
      <h3>Post a comment</h3>
     <form action="/blog/jim/2010/06/29/ruby-metaprogramming-is-awesome/comments" method="post" >
      
      <p><label for="comment_author">Your Name</label><br />
      
      <input type="text" id="comment_author" name="comment[author]" class="required" /></p>

      <p><label for="comment_author_email">Your Email Address</label> (required, but not displayed)<br />
      
      <input type="text" id="comment_author_email" name="comment[author_email]" class="required" /></p>

      <p><label for="comment_author_url">Your Web Address</label> (optional)<br />
      
      <input type="text" id="comment_author_url" name="comment[author_url]" /></p>

      <p><label for="comment_content">Your Comment</label><br />
      
      <label for="comment_filter_id">Filter: <select name="comment[filter_id]"><option value="SCSS">SCSS</option><option value="Sass">Sass</option><option value="SmartyPants">SmartyPants</option><option value="Markdown">Markdown</option><option value="Textile" selected="selected">Textile</option></select></label><br />
      <textarea id="comment_content" name="comment[content]" class="required" rows="9" cols="40"></textarea></p>


      <p><label for="comment_spam_answer">What is ROBOT spelled backwards?</label> (required)<br />
      <input type="text" id="comment_spam_answer" name="comment[spam_answer]" value=""  /><input type="hidden" name="comment[valid_spam_answer]" value="1f08efaf9dbd5542f3110d26a2ab4ca1" /></p>


      <input type="submit" id="submit" name="submit" value="Save Comment"  />

    </form>
  






<div class="sidebar">

<div class="addition extra">
<h2>Get more information.</h2>

<p>Jim Gay also posts on the <a href="http://www.radiantcms.org/blog">Radiant CMS blog</a> along other core members.</p>

<h2>In-depth thoughts</h2>

<p>Check out some of our <a href="http://www.saturnflyer.com/articles/">articles</a>.</p>
</div>


</div>

</div>
<div id="navigation" class="spaced">
<ul class="inline_list">
<li><a href="/about/">About Us</a></li>
<li><a href="/services/">Services</a></li>
<li><a href="/projects/">Client Projects</a></li>
<li><a href="/products/">Our Products</a></li>
<li class="literature"><a href="/blog/">Blog</a></li>
</ul>
</div>

<div class="addition spaced" style="width: 800px; margin: 1em auto">
		<p>1999 - 2013 &copy; <a href="http://www.saturnflyer.com/">Saturn Flyer LLC</a> 2321 S. Buchanan St. Arlington, VA 22206</p>
		<p>Call Jim Gay at 571 403 0338</p>
	</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-3894220-1");
pageTracker._trackPageview();
</script></div>
</body>
</html>